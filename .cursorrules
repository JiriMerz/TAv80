# Trading Assistant - Cursor Rules & Project Context

## ğŸ¯ Project Overview
AutomatickÃ½ swing trading assistant pro DAX a NASDAQ, bÄ›Å¾Ã­cÃ­ na Raspberry Pi s Home Assistant a AppDaemon. PouÅ¾Ã­vÃ¡ cTrader Open API pro obchodovÃ¡nÃ­.

## ğŸ“ Project Structure
```
Main project:    /Users/jirimerz/Projects/TAv80/
Worktree:        /Users/jirimerz/.cursor/worktrees/TAv80/jir/
RPi deployment:  /Volumes/addon_configs/a0d7b954_appdaemon/apps/
```

## ğŸ”„ Deployment Workflow (VÅ½DY DODRÅ½OVAT!)
1. **Edit** - Upravit soubory v aktuÃ¡lnÃ­m workspace
2. **Sync to worktree** - `cp <file> /Users/jirimerz/.cursor/worktrees/TAv80/jir/<path>`
3. **Deploy to RPi** - `cp <file> /Volumes/addon_configs/a0d7b954_appdaemon/apps/<path>`
4. **Verify** - `md5 <local> <worktree> <rpi>` - vÅ¡echny 3 hashe musÃ­ bÃ½t stejnÃ©
5. **Restart AppDaemon** - UÅ¾ivatel restartuje ruÄnÄ› pÅ™es HA UI

## ğŸ“ Key Files
| Soubor | Cesta | ÃšÄel |
|--------|-------|------|
| main.py | src/trading_assistant/ | HlavnÃ­ aplikaÄnÃ­ logika, zpracovÃ¡nÃ­ dat, signÃ¡ly |
| ctrader_client.py | src/trading_assistant/ | WebSocket pÅ™ipojenÃ­ k cTrader API |
| apps.yaml | src/ | AppDaemon konfigurace, trading hours, holidays |
| dashboard.yaml | / | Home Assistant dashboard |
| edges.py | src/trading_assistant/ | Detekce obchodnÃ­ch signÃ¡lÅ¯ |
| regime.py | src/trading_assistant/ | Detekce trÅ¾nÃ­ho reÅ¾imu (TREND_UP/DOWN/RANGING) |
| pullback_detector.py | src/trading_assistant/ | Detekce pullbackÅ¯ pro swing trading |

## âš™ï¸ System Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cTrader API    â”‚â”€â”€â”€â”€â–¶â”‚  AppDaemon/RPi   â”‚â”€â”€â”€â”€â–¶â”‚  Home Assistant â”‚
â”‚  (WebSocket)    â”‚     â”‚  (Python app)    â”‚     â”‚  (Dashboard)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ• Trading Hours (CET timezone)
- **DAX (GER40)**: 09:00 - 15:30
- **NASDAQ (US100)**: 15:30 - 22:00

## ğŸ“… Market Holidays (2025-2026)
KonfigurovÃ¡ny v `apps.yaml` pod `market_holidays`:
- DAX: XETRA holidays (NovÃ½ rok, Velikonoce, VÃ¡noce, atd.)
- NASDAQ: US holidays (MLK Day, Presidents Day, Thanksgiving, atd.)

## ğŸ”§ Recent Fixes (Keep Updated!)
1. **Race condition fix** (2026-01-01): `_process_data()` nynÃ­ kontroluje pÅ™Ã­mo `ctrader_client.is_connected()` mÃ­sto HA entity (ta mÄ›la zpoÅ¾dÄ›nÃ­ 30s)
2. **TypeError fix** (2026-01-01): PÅ™idÃ¡na kontrola `None` hodnot pro `current_price` a `last_price`
3. **Token refresh** (2026-01-01): ImplementovÃ¡n automatickÃ½ refresh cTrader access tokenu

## ğŸ”‘ cTrader API
- **Demo server**: wss://demo.ctraderapi.com:5036
- **Account ID**: 42478187
- **Symbols**: US100 (ID: 208), GER40 (ID: 203)
- **Credentials**: V `/Volumes/addon_configs/a0d7b954_appdaemon/secrets.yaml`

## ğŸ“Š Trading Strategy
- **Typ**: Swing trading na pullbacky v trendu
- **Regime detection**: ADX + Linear Regression pro urÄenÃ­ trendu
- **Entry**: Pullback do 38.2%-61.8% Fibonacci zÃ³ny s reversal patternem
- **EMA34 filter**: Obchoduje se pouze ve smÄ›ru EMA34 trendu
- **Risk**: 0.5-0.6% na obchod, max 4% dennÄ›

## ğŸ  Home Assistant Entities
- `binary_sensor.ctrader_connected` - Stav pÅ™ipojenÃ­ k cTrader
- `sensor.trading_analysis_status` - RUNNING/STOPPED
- `sensor.dax_market_status` - OPEN/CLOSED
- `sensor.nasdaq_market_status` - OPEN/CLOSED
- `input_boolean.auto_trading_enabled` - HlavnÃ­ pÅ™epÃ­naÄ obchodovÃ¡nÃ­

## ğŸ› Debugging Tips
- Log je v AppDaemon addon logu (HA â†’ Settings â†’ Add-ons â†’ AppDaemon â†’ Log)
- `[SYSTEM_CHECK]` - Kontrola stavu pÅ™ed zpracovÃ¡nÃ­m dat
- `[PROCESS_DATA]` - ZpracovÃ¡nÃ­ trÅ¾nÃ­ch dat
- `[REGIME]` - Detekce trÅ¾nÃ­ho reÅ¾imu
- `[PULLBACK]` - Detekce pullbackÅ¯

## ğŸ‡¨ğŸ‡¿ Communication
- UÅ¾ivatel preferuje **Äesky**
- TechnickÃ© termÃ­ny lze ponechat v angliÄtinÄ›

## ğŸ“‹ Typical Tasks
1. **Kontrola logu** - Analyzovat AppDaemon log, najÃ­t chyby
2. **Oprava kÃ³du** - Edit â†’ Sync â†’ Deploy â†’ Verify â†’ Restart
3. **Konfigurace** - Ãšpravy v apps.yaml (holidays, trading hours)
4. **Dashboard** - Ãšpravy v dashboard.yaml, import pÅ™es HA raw editor

## âš ï¸ Important Notes
- NIKDY nemÄ›nit git config
- RPi je pÅ™ipojeno pÅ™es SMB mount na /Volumes/addon_configs/
- PÅ™ed editacÃ­ vÅ¾dy pÅ™eÄÃ­st aktuÃ¡lnÃ­ stav souboru
- Po zmÄ›nÃ¡ch vÅ¾dy ovÄ›Å™it MD5 vÅ¡ech 3 kopiÃ­
