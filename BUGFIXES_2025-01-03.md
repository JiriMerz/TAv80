# Bug Fixes - 2025-01-03

## Bug 1: NASDAQ Trading Hours Mismatch ✅ FIXED

### Problem
The NASDAQ trading hours were changed from `15:30-22:00` to `14:30-22:00` in the configuration file (`apps.yaml`), but hardcoded values in `edges.py` still referenced the old `15:30-22:00` hours. This created inconsistency where:
- Configuration: `14:30-22:00` (correct)
- `main.py` line 3106: `14:30-22:00 CET` (correct)
- `edges.py` line 1052: Comment said `9:00-15:30 CET` for DAX (incorrect - should be `9:00-14:30`)
- `edges.py` line 1053: Logic checked `(9 <= hour < 15) or (hour == 15 and now.minute <= 30)` (incorrect - should check until 14:30)

### Root Cause
The comment and logic in `edges.py` were not updated when NASDAQ trading hours were changed from `15:30` to `14:30`.

### Solution
**File**: `src/trading_assistant/edges.py` (lines 1052-1053)

**Before**:
```python
if 'DAX' in symbol.upper() or 'DE40' in symbol.upper():
    # DAX quality hours: 9:00-15:30 CET
    return (9 <= hour < 15) or (hour == 15 and now.minute <= 30)
```

**After**:
```python
if 'DAX' in symbol.upper() or 'DE40' in symbol.upper():
    # DAX quality hours: 9:00-14:30 CET
    return (9 <= hour < 14) or (hour == 14 and now.minute <= 30)
```

### Impact
- ✅ DAX trading hours now correctly match configuration: `9:00-14:30`
- ✅ NASDAQ trading hours already correct: `14:30-22:00`
- ✅ All trading hour references now consistent across codebase

---

## Bug 2: Incorrect Execution Type Check ✅ VERIFIED

### Problem Description
The user reported that the code checks `if execution_type == 3` before calling `_handle_position_close_for_risk_manager()`, but according to the comments:
- Execution type 3 = order filled/position opened
- Execution type 5 = position closed

This would mean the position close handler would never be called correctly.

### Verification
**File**: `src/trading_assistant/account_state_monitor.py` (line 459)

**Current Code**:
```python
# CRITICAL FIX: Update risk manager when positions close
# Use status field (2 or 3 = closed) instead of execution_type
# Execution type 3 = order filled/position opened, type 5 = position closed
# But status field is more reliable: status 2 = closed, status 3 = partially closed
if status in [2, 3] and self.risk_manager:  # Position closed
    self._handle_position_close_for_risk_manager(payload)
```

### Status
✅ **ALREADY CORRECT** - The current code uses `status in [2, 3]` instead of `execution_type == 3`, which is the correct approach:
- Status 2 = position closed
- Status 3 = position partially closed
- Execution type 3 = order filled/position opened (NOT position closed)

The code correctly uses the `positionStatus` field rather than `executionType` to detect position closures.

### Note
If there was an older version with `execution_type == 3` check, it has already been fixed. The current implementation is correct.

---

## Files Modified

1. ✅ `src/trading_assistant/edges.py` - Fixed DAX trading hours comment and logic

## Files Verified (No Changes Needed)

1. ✅ `src/trading_assistant/account_state_monitor.py` - Already uses correct `status in [2, 3]` check

---

## Testing Recommendations

1. **Bug 1**: Verify that DAX signals are only generated during `9:00-14:30` hours
2. **Bug 2**: Verify that position close events correctly trigger risk manager updates when positions close (status 2 or 3)

---

*Both bugs verified and addressed. Bug 1 fixed, Bug 2 confirmed as already correct.*
